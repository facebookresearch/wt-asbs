# @package _global_

name: ptsb

################################################################################
# Material setup
################################################################################

pbc: [false, false, false]
cell: null
temperature: 300.0
composition: C7OH4CHCHC2HCH3C3H6
num_atoms: 32
mean_free: true
charge: 0
spin: 1

################################################################################
# Models
################################################################################

controller:
  _target_: wt_asbs.model.controller.ClippedModel
  base_model:
    _target_: wt_asbs.model.painn_fc.PaiNN
    num_features: 128
    num_radial_basis: 64
    num_layers: 4
    r_max: 8.0
    r_offset: 0.0
    time_init_mode: node
    conservative: false
    num_elements: ${num_atoms}
    unique_atom_indices: true
  subtract_mean: true
  clip_value: null

corrector:
  _target_: wt_asbs.model.controller.ClippedModel
  base_model:
    _target_: wt_asbs.model.painn_fc.PaiNN
    num_features: 128
    num_radial_basis: 64
    num_layers: 3
    r_max: 8.0
    r_offset: 0.0
    time_init_mode: none
    conservative: false
    num_elements: ${num_atoms}
    unique_atom_indices: true
  subtract_mean: true
  clip_value: null

################################################################################
# Optimization
################################################################################

pretrain_optimizer:
  _target_: torch.optim.AdamW
  lr: 3e-4
  weight_decay: 0.001

controller_optimizer:
  _target_: torch.optim.AdamW
  lr: 3e-5
  weight_decay: 0.001

corrector_optimizer:
  _target_: torch.optim.AdamW
  lr: 3e-5
  weight_decay: 0.001

gradient_clip_val: 100.0
ema_decay: null
ema_start_step: 0

################################################################################
# Buffers
################################################################################

adjoint_buffer:
  _target_: wt_asbs.data.buffer.ThermoAtomicDataBuffer
  max_size: 512
  filter_nan: true

corrector_buffer:
  _target_: wt_asbs.data.buffer.ThermoAtomicDataBuffer
  max_size: 512
  filter_nan: true

initial_buffer_samples: 64
buffer_samples_per_epoch: 64
log_buffer_energy: true
log_buffer_grad_norm: true

################################################################################
# Process and integration
################################################################################

source:
  _target_: wt_asbs.process.source.GaussianSource
  pbc: ${pbc}
  cell: ${cell}
  composition: ${composition}
  temperature: ${temperature}
  charge: ${charge}
  spin: ${spin}
  center: ${mean_free}

pretrain_target:
  _target_: wt_asbs.process.source.PreGeneratedAtomsSource
  atoms_file: md_data/ptsb/md_10ps.xyz

bridge_matching_max_time: 0.99  # time cutoff for numerically stable score computation

base_sde:
  _target_: wt_asbs.process.sde.EDMSDE
  sigma_min: 0.001
  sigma_max: 6.0
  rho: 3.0

integrator:
  _target_: wt_asbs.process.integrator.EulerMaruyamaIntegrator
  timesteps:
    _target_: wt_asbs.process.integrator.get_timesteps
    t0: 0.0
    t1: 1.0
    steps: 250
    rescale_t: null

################################################################################
# Potential and terminal cost
################################################################################

potential:
  _target_: wt_asbs.potential.base.SumPotential
  potentials:
    - _target_: wt_asbs.potential.uma.UMAPotential
      model_name: uma-s-1p1
      task_name: omol
      device: cuda
    - ${metadynamics}
    - ${cv_restraint}
    - ${bond_restraint_1}
    - ${bond_restraint_2}
    - ${plane_restraint}

metadynamics:
  _target_: wt_asbs.potential.metadynamics.WellTemperedMetadynamicsBias
  cv: ${cv}
  height: 0.0002
  sigma: [0.05, 0.05]
  grid_min: [0.0, -1.0]
  grid_max: [3.0, 1.0]
  grid_bin: [300, 200]
  bias_factor: 30.0
  temperature: ${temperature}
  add_every_epoch: 1
  skip_initial_epochs: 50

cv:
  _target_: wt_asbs.potential.metadynamics.collective_variable.ListCV
  cv_list:
    - _target_: wt_asbs.potential.metadynamics.collective_variable.LinearCombinationCV  # c1 + c2 + c3
      cv:
        _target_: wt_asbs.potential.metadynamics.collective_variable.CoordinationCV
        indices: [[1, 14], [2, 12], [6, 23]]
        r_0: 1.7
        n: 6
        m: 8
      weights: [1.0, 1.0, 1.0]
    - _target_: wt_asbs.potential.metadynamics.collective_variable.LinearCombinationCV  # c2 - c3
      cv:
        _target_: wt_asbs.potential.metadynamics.collective_variable.CoordinationCV
        indices: [[2, 12], [6, 23]]
        r_0: 1.7
        n: 6
        m: 8
      weights: [1.0, -1.0]

cv_restraint:
  _target_: wt_asbs.potential.metadynamics.restraint.HarmonicRestraint
  cv:
    _target_: wt_asbs.potential.metadynamics.collective_variable.DistanceCV
    indices: [[1, 14], [2, 12], [6, 23]]
  location: [3.6, 4.0, 4.0]
  force_constant: [100.0, 100.0, 100.0]  # eV/Å^2
  direction: "upper"  # no escape from the well

bond_restraint_1:  # Restrain covalent bond breaking
  _target_: wt_asbs.potential.metadynamics.restraint.HarmonicRestraint
  cv:
    _target_: wt_asbs.potential.metadynamics.collective_variable.DistanceCV
    indices: [[0, 7], [0, 1], [0, 2], [1, 3], [2, 4], [3, 5], [4, 6], [5, 6], [12, 16], [12, 19], [14, 16], [14, 17], [17, 19], [16, 23], [23, 24], [23, 25], [1, 15], [2, 13], [3, 8], [4, 11], [5, 9], [6, 10], [12, 20], [14, 18], [17, 21], [19, 22], [24, 29], [24, 30], [24, 31], [25, 26], [25, 27], [25, 28]]
  location: [1.84, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.97, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39, 1.39]  # 1.3 * covalent radii
  force_constant: [100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0]  # eV/Å^2
  direction: "upper"  # no bond breaking

bond_restraint_2:  # Restrain covalent bond formation
  _target_: wt_asbs.potential.metadynamics.restraint.HarmonicRestraint
  cv:
    _target_: wt_asbs.potential.metadynamics.collective_variable.DistanceCV
    indices: [[5, 23], [2, 17], [7, 19]]
  location: [2.38, 2.38, 2.25]  # 0.7 * vdW radii
  force_constant: [100.0, 100.0, 100.0]  # eV/Å^2
  direction: "lower"  # no bond formation

plane_restraint:  # Relative positions for two reactants
  _target_: wt_asbs.potential.metadynamics.restraint.HarmonicRestraint
  cv:
    _target_: wt_asbs.potential.metadynamics.collective_variable.PlanarDistanceCV
    indices_1: [14, 12, 23]  # dimethylfulvene
    indices_2: [1, 2, 6]  # tropone
  location: [0.0]
  force_constant: [100.0]  # eV/Å^2
  direction: "lower"  # tropone should be above dimethylfulvene

terminal_cost:
  _target_: wt_asbs.process.terminal_cost.ASBSTerminalCost
  grad_clip_val: 100.0

annealer:
  _target_: wt_asbs.process.annealer.TemperatureAnnealer
  epochs: [0, 500]
  temperatures: [300.0, 300.0]  # no annealing

################################################################################
# Training settings
################################################################################

train_batch_size: 64
inference_batch_size: 64
steps_per_epoch: 100
log_step_loss: true

pretrain_curriculum:
  - bridge_matching: 1000
curriculum:
  - adjoint_matching: 1000
  - corrector_matching: 500
  - adjoint_matching: 1000
  - corrector_matching: 500
  - adjoint_matching: 1000
  - corrector_matching: 500
  - adjoint_matching: 1000
  - corrector_matching: 500
  - adjoint_matching: 1000

skip_scheduler_steps: 0
pretrain_scheduler:
  _target_: wt_asbs.utils.training.CosineAnnealingWithWarmupScheduler
  curriculum:
    _target_: wt_asbs.utils.training.TrainingCurriculum
    curriculum: ${pretrain_curriculum}
  task_name: bridge_matching
  steps_per_epoch: ${steps_per_epoch}
  warmup_epochs: 50
  eta_min: 1e-4
controller_scheduler:
  _target_: wt_asbs.utils.training.CosineAnnealingWithWarmupScheduler
  curriculum:
    _target_: wt_asbs.utils.training.TrainingCurriculum
    curriculum: ${curriculum}
  task_name: adjoint_matching
  steps_per_epoch: ${steps_per_epoch}
  warmup_epochs: ${metadynamics.skip_initial_epochs}
  eta_min: 1e-5
corrector_scheduler:
  _target_: wt_asbs.utils.training.CosineAnnealingWithWarmupScheduler
  curriculum:
    _target_: wt_asbs.utils.training.TrainingCurriculum
    curriculum: ${curriculum}
  task_name: corrector_matching
  steps_per_epoch: ${steps_per_epoch}
  warmup_epochs: 50
  eta_min: 1e-5
