# @package _global_

name: sn2

################################################################################
# Material setup
################################################################################

pbc: [false, false, false]
cell: null
temperature: 300.0
composition: CH3Cl2
num_atoms: 6
mean_free: true
charge: -1
spin: 1

################################################################################
# Models
################################################################################

controller:
  _target_: wt_asbs.model.controller.ClippedModel
  base_model:
    _target_: wt_asbs.model.painn_fc.PaiNN
    num_features: 64
    num_radial_basis: 32
    num_layers: 3
    r_max: 8.0
    r_offset: 0.0
    time_init_mode: node
    conservative: false
    num_elements: ${num_atoms}
    unique_atom_indices: true
  subtract_mean: true
  clip_value: null

corrector:
  _target_: wt_asbs.model.controller.ClippedModel
  base_model:
    _target_: wt_asbs.model.painn_fc.PaiNN
    num_features: 64
    num_radial_basis: 32
    num_layers: 3
    r_max: 8.0
    r_offset: 0.0
    time_init_mode: none
    conservative: false
    num_elements: ${num_atoms}
    unique_atom_indices: true
  subtract_mean: true
  clip_value: null

################################################################################
# Optimization
################################################################################

pretrain_optimizer:
  _target_: torch.optim.AdamW
  lr: 3e-4
  weight_decay: 0.001

controller_optimizer:
  _target_: torch.optim.AdamW
  lr: 3e-5
  weight_decay: 0.001

corrector_optimizer:
  _target_: torch.optim.AdamW
  lr: 3e-5
  weight_decay: 0.001

gradient_clip_val: 100.0
ema_decay: null
ema_start_step: 0

################################################################################
# Buffers
################################################################################

adjoint_buffer:
  _target_: wt_asbs.data.buffer.ThermoAtomicDataBuffer
  max_size: 512
  filter_nan: true

corrector_buffer:
  _target_: wt_asbs.data.buffer.ThermoAtomicDataBuffer
  max_size: 512
  filter_nan: true

initial_buffer_samples: 64
buffer_samples_per_epoch: 64
log_buffer_energy: true
log_buffer_grad_norm: true

################################################################################
# Process and integration
################################################################################

source:
  _target_: wt_asbs.process.source.GaussianSource
  pbc: ${pbc}
  cell: ${cell}
  composition: ${composition}
  temperature: ${temperature}
  charge: ${charge}
  spin: ${spin}
  center: ${mean_free}

pretrain_target:
  _target_: wt_asbs.process.source.PreGeneratedAtomsSource
  atoms_file: md_data/sn2/sn2_opt.xyz

bridge_matching_max_time: 0.99  # time cutoff for numerically stable score computation

base_sde:
  _target_: wt_asbs.process.sde.EDMSDE
  sigma_min: 0.001
  sigma_max: 5.0
  rho: 3.0

integrator:
  _target_: wt_asbs.process.integrator.EulerMaruyamaIntegrator
  timesteps:
    _target_: wt_asbs.process.integrator.get_timesteps
    t0: 0.0
    t1: 1.0
    steps: 250
    rescale_t: null

################################################################################
# Potential and terminal cost
################################################################################

potential:
  _target_: wt_asbs.potential.base.SumPotential
  potentials:
    - _target_: wt_asbs.potential.uma.UMAPotential
      model_name: uma-s-1p1
      task_name: omol
      device: cuda
    - ${metadynamics}
    - ${cv_restraint}
    - ${bond_restraint}

metadynamics:
  _target_: wt_asbs.potential.metadynamics.WellTemperedMetadynamicsBias
  cv: ${cv}
  height: 0.0005
  sigma: [0.2, 0.2]
  grid_min: [1.0, 1.0]
  grid_max: [4.0, 4.0]
  grid_bin: [150, 150]
  bias_factor: 12.0
  temperature: ${temperature}
  add_every_epoch: 1
  skip_initial_epochs: 50

cv:
  _target_: wt_asbs.potential.metadynamics.collective_variable.DistanceCV
  indices: [[0, 4], [0, 5]]

cv_restraint:
  _target_: wt_asbs.potential.metadynamics.restraint.HarmonicRestraint
  cv: ${cv}
  location: [3.3, 3.3]
  force_constant: [100.0, 100.0]  # eV/Å^2
  direction: "upper"  # no escape from the well

bond_restraint:  # Constraints for hydrogen atoms
  _target_: wt_asbs.potential.metadynamics.restraint.HarmonicRestraint
  cv:
    _target_: wt_asbs.potential.metadynamics.collective_variable.DistanceCV
    indices: [[0, 1], [0, 2], [0, 3]]
  location: [1.39, 1.39, 1.39]  # 1.3 * covalent radii
  force_constant: [100.0, 100.0, 100.0]  # eV/Å^2
  direction: "upper"  # no bond breaking

terminal_cost:
  _target_: wt_asbs.process.terminal_cost.ASBSTerminalCost
  grad_clip_val: 100.0

annealer:
  _target_: wt_asbs.process.annealer.TemperatureAnnealer
  epochs: [0, 500]
  temperatures: [300.0, 300.0]  # no annealing

################################################################################
# Training settings
################################################################################

train_batch_size: 64
inference_batch_size: 64
steps_per_epoch: 100
log_step_loss: true

pretrain_curriculum:
  - bridge_matching: 200
curriculum:
  - adjoint_matching: 500
  - corrector_matching: 250
  - adjoint_matching: 500
  - corrector_matching: 250
  - adjoint_matching: 500

skip_scheduler_steps: 0
pretrain_scheduler:
  _target_: wt_asbs.utils.training.CosineAnnealingWithWarmupScheduler
  curriculum:
    _target_: wt_asbs.utils.training.TrainingCurriculum
    curriculum: ${pretrain_curriculum}
  task_name: bridge_matching
  steps_per_epoch: ${steps_per_epoch}
  warmup_epochs: 50
  eta_min: 1e-4
controller_scheduler:
  _target_: wt_asbs.utils.training.CosineAnnealingWithWarmupScheduler
  curriculum:
    _target_: wt_asbs.utils.training.TrainingCurriculum
    curriculum: ${curriculum}
  task_name: adjoint_matching
  steps_per_epoch: ${steps_per_epoch}
  warmup_epochs: ${metadynamics.skip_initial_epochs}
  eta_min: 1e-5
corrector_scheduler:
  _target_: wt_asbs.utils.training.CosineAnnealingWithWarmupScheduler
  curriculum:
    _target_: wt_asbs.utils.training.TrainingCurriculum
    curriculum: ${curriculum}
  task_name: corrector_matching
  steps_per_epoch: ${steps_per_epoch}
  warmup_epochs: 50
  eta_min: 1e-5
